<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FurniCraft CAD - Professional Workstation</title>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

  <style>
    :root {
      --bg-dark: #1e1e1e;
      --bg-panel: #252526;
      --bg-header: #333333;
      --accent: #d35400;
      --select-blue: #007acc; 
      --text-main: #e0e0e0;
      --text-dim: #999;
      --border: #3e3e42;
      --gold: #f1c40f;
      --rec-bg: #2c2918;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      height: 45px;
      background-color: var(--bg-header);
      display: flex;
      align-items: center;
      padding: 0 1rem;
      border-bottom: 1px solid var(--border);
      justify-content: space-between;
    }
    .brand { font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
    .header-controls button {
      background: transparent; border: none; color: var(--text-main);
      margin-left: 15px; cursor: pointer; font-size: 0.9rem;
    }
    .header-controls button:hover { color: var(--accent); }
    
    .btn-export {
      background: #27ae60 !important; 
      color: white !important;
      padding: 5px 12px;
      border-radius: 4px;
      font-weight: 600;
      transition: 0.2s;
    }
    .btn-export:hover { background: #2ecc71 !important; }

    /* WORKSPACE */
    .workspace { display: flex; flex: 1; height: calc(100vh - 45px); }

    /* LEFT SIDEBAR */
    .panel-left {
      width: 220px;
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    .panel-header {
      padding: 12px; font-size: 0.75rem; font-weight: 700; 
      text-transform: uppercase; color: var(--text-dim);
      border-bottom: 1px solid var(--border);
    }
    .scene-list { flex: 1; overflow-y: auto; padding: 5px; }
    .scene-item {
      padding: 10px; margin-bottom: 2px;
      border-radius: 4px; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
    }
    .scene-item:hover { background-color: #333; }
    .scene-item.active { background-color: #37373d; border-left: 3px solid var(--accent); }
    .btn-delete { background: none; border: none; color: #666; cursor: pointer; }
    .btn-delete:hover { color: #c0392b; }
    
    .btn-add {
      width: 100%; padding: 12px;
      background: var(--accent); color: white; border: none;
      cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    /* CENTER VIEWPORT */
    .viewport { flex: 1; position: relative; background: radial-gradient(circle at center, #2d2d30 0%, #1e1e1e 100%); }
    #canvas-container { width: 100%; height: 100%; outline: none; }
    
    #export-overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.85); z-index: 100;
      display: none; flex-direction: column; align-items: center; justify-content: center;
      color: white;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--accent);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* SCORE CARD */
    .score-card {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px;
      width: 200px; border: 1px solid var(--border); pointer-events: none;
    }
    .score-title { font-size: 0.7rem; color: #aaa; text-transform: uppercase; margin-bottom: 8px; }
    .score-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; }
    .score-bar-bg { width: 100%; height: 4px; background: #444; margin-top: 2px; border-radius: 2px; }
    .score-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s; }

    /* RIGHT SIDEBAR */
    .panel-right {
      width: 380px;
      background-color: var(--bg-panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    .prop-scroll { flex: 1; overflow-y: auto; }
    .prop-group { padding: 15px; border-bottom: 1px solid var(--border); }
    .prop-label { font-size: 0.75rem; font-weight: 700; color: var(--text-dim); margin-bottom: 8px; display: block; text-transform: uppercase; }

    input[type="text"], select {
      width: 100%; background: #3c3c3c; border: 1px solid var(--border);
      color: white; padding: 8px; border-radius: 4px; font-family: inherit; margin-bottom: 5px;
    }

    .range-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.8rem; }
    .range-row label { width: 50px; }
    input[type="range"] { flex: 1; accent-color: var(--accent); }
    .val-display { width: 35px; text-align: right; color: var(--text-dim); font-size:0.8rem; }

    .mat-section-title { color: var(--gold); font-size: 0.8rem; font-weight: bold; margin: 0 0 8px 0; display: flex; align-items: center; gap: 5px; }
    .mat-grid-large { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px; }
    .mat-card-lg {
      background: #333; border: 1px solid var(--border); border-radius: 4px;
      padding: 8px; text-align: center; cursor: pointer; transition: 0.1s; position: relative;
    }
    .mat-card-lg:hover { transform: translateY(-2px); background: #3e3e42; border-color:white; }
    .mat-card-lg.recommended { background: var(--rec-bg); border-color: #554a1f; }
    
    .mat-card-icon { font-size: 1.2rem; margin-bottom: 4px; }
    .mat-card-name { font-size: 0.7rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .layer-item {
      background: #2b2b2b; border-radius: 4px; margin-bottom: 8px; border: 1px solid #333;
      transition: all 0.2s;
    }
    .layer-item.active-layer {
      border: 1px solid var(--select-blue);
      box-shadow: 0 0 8px rgba(0, 122, 204, 0.3);
    }
    .layer-header {
      padding: 10px; display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; background: #333;
    }
    .layer-header:hover { background: #3c3c3c; }
    .color-preview { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #777; }
    .layer-content { display: none; padding: 15px; background: #222; border-top: 1px solid #444; }
    .layer-item.open .layer-content { display: block; }

    .part-control-row { margin-bottom: 15px; }
    .part-control-label { font-size: 0.75rem; color: #aaa; margin-bottom: 5px; display: block; }
    
    .hex-wrapper { display: flex; align-items: center; gap: 8px; }
    input[type="color"] { -webkit-appearance: none; border: none; width: 40px; height: 40px; cursor: pointer; background: none; padding: 0; }
    .hex-text-input { width: 90px !important; margin:0 !important; font-family: monospace; text-transform: uppercase; }

    .dim-row { display: flex; gap: 5px; margin-top: 5px; }
    .dim-group { flex: 1; }
    .dim-input { 
      width: 100%; background: #111; border: 1px solid #444; color: var(--accent); 
      padding: 5px; text-align: center; font-size: 0.8rem; border-radius: 3px;
    }
    .dim-label { font-size: 0.65rem; color: #666; text-align: center; }

    .footer-bar {
      padding: 15px; background: #202020; border-top: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .total-price { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
    
    .instruction-text { font-size: 0.75rem; color: var(--select-blue); margin-bottom: 10px; font-style: italic; }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <i class="fas fa-cube"></i> FurniCraft Studio
    </div>
    <div class="header-controls">
      <button id="btn-rotate" onclick="toggleRotation()"><i class="fas fa-pause"></i> Stop Rotate</button>
      
      <button onclick="init3D()"><i class="fas fa-sync"></i> Reset Cam</button>
      <button class="btn-export" onclick="exportGIF()"><i class="fas fa-file-export"></i> Export 360Â° GIF</button>
    </div>
  </header>

  <div class="workspace">

    <aside class="panel-left">
      <div class="panel-header">Scene Explorer</div>
      <div class="scene-list" id="scene-list"></div>
      <button class="btn-add" onclick="addFurniture()">
        <i class="fas fa-plus"></i> Add Furniture
      </button>
    </aside>

    <main class="viewport">
      <div id="canvas-container"></div>
      
      <div id="export-overlay">
        <div class="spinner"></div>
        <h3>Rendering GIF...</h3>
        <p style="font-size:0.8rem; color:#aaa">Please wait while we capture dimensions and rotation.</p>
      </div>
      
      <div class="score-card">
        <div class="score-title">Design Analysis</div>
        <div class="score-row"><span>Durability</span><span id="score-dura-val">0%</span></div>
        <div class="score-bar-bg"><div id="bar-dura" class="score-bar-fill" style="width:0%"></div></div>
        <div class="score-row" style="margin-top:10px;"><span>Material Quality</span><span id="score-qual-val">0%</span></div>
        <div class="score-bar-bg"><div id="bar-qual" class="score-bar-fill" style="width:0%"></div></div>
        <div id="rec-status" style="margin-top:10px; font-size:0.7rem; color:var(--good);"></div>
      </div>
    </main>

    <aside class="panel-right">
      <div class="panel-header">Properties</div>
      
      <div class="prop-scroll">
        
        <div class="prop-group">
          <label class="prop-label">Material Library</label>
          <div class="instruction-text">Select a Layer below, then click a Material here to apply.</div>
          
          <div id="rec-mat-container" style="display:none">
            <div class="mat-section-title"><i class="fas fa-star"></i> Recommended</div>
            <div class="mat-grid-large" id="rec-mat-grid"></div>
          </div>
          
          <div class="mat-section-title" style="color:#777; margin-top:10px;">All Materials</div>
          <div class="mat-grid-large" id="all-mat-grid"></div>
        </div>

        <div class="prop-group">
          <label class="prop-label">Project Settings</label>
          <input type="text" id="project-name" placeholder="Project Name" oninput="updateProjectName(this.value)">
          
          <label class="prop-label" style="margin-top:10px">Carving Style</label>
          <select id="design-style" onchange="updateCarving(this.value)">
            <option value="none">None (Smooth)</option>
            <option value="floral">Classic Floral (Ukit)</option>
            <option value="geometric">Modern Geometric</option>
          </select>

          <label class="prop-label" style="margin-top:10px">Global Scale</label>
          <div class="range-row"><label>W</label><input type="range" id="inp-scale-x" min="50" max="200" value="100" oninput="updateGlobalScale('x', this.value)"><span class="val-display" id="gs-x">100</span></div>
          <div class="range-row"><label>H</label><input type="range" id="inp-scale-y" min="50" max="200" value="100" oninput="updateGlobalScale('y', this.value)"><span class="val-display" id="gs-y">100</span></div>
          <div class="range-row"><label>D</label><input type="range" id="inp-scale-z" min="50" max="200" value="100" oninput="updateGlobalScale('z', this.value)"><span class="val-display" id="gs-z">100</span></div>
        </div>

        <div class="prop-group">
          <label class="prop-label">Layers (Select to Edit)</label>
          <div id="layers-container"></div>
        </div>

      </div>

      <div class="footer-bar">
        <span style="font-size:0.8rem; color:#888;">ESTIMATED COST</span>
        <div class="total-price" id="total-price">â‚±0.00</div>
      </div>
    </aside>

  </div>

  <script>
    // --- DATABASE ---
    const materialDB = {
      narra: { name: 'Narra', icon:'ðŸŒ³', hex: '#8B4513', dura: 95, qual: 98, price: 200, rec: ['table', 'chair', 'cabinet', 'bed', 'desk'] },
      mahogany: { name: 'Mahogany', icon:'ðŸªµ', hex: '#5c3a21', dura: 85, qual: 90, price: 150, rec: ['table', 'bookshelf', 'cabinet'] },
      oak: { name: 'Oak', icon:'ðŸŒ³', hex: '#d4ac7d', dura: 80, qual: 85, price: 120, rec: ['bed', 'bookshelf'] },
      steel: { name: 'Steel', icon:'âš™ï¸', hex: '#95a5a6', dura: 99, qual: 80, price: 250, rec: ['desk', 'stool'] },
      fabric: { name: 'Fabric', icon:'ðŸ§¶', hex: '#34495e', dura: 60, qual: 85, price: 80, rec: ['sofa', 'stool', 'chair'] },
      leather: { name: 'Leather', icon:'ðŸ„', hex: '#2c3e50', dura: 75, qual: 95, price: 300, rec: ['sofa', 'chair', 'stool'] },
      plastic: { name: 'Plastic', icon:'â™³', hex: '#ecf0f1', dura: 50, qual: 40, price: -20, rec: [] },
      glass: { name: 'Glass', icon:'ðŸ’Ž', hex: '#a8e6cf', dura: 60, qual: 90, price: 150, rec: [] },
      white: { name: 'White', icon:'âšª', hex: '#eeeeee', dura: 70, qual: 70, price: 50, rec: [] }
    };

    const assetsDB = {
      chair: { name: 'Dining Chair', basePrice: 2500, parts: ['Seat', 'Back', 'Legs'] },
      table: { name: 'Dining Table', basePrice: 5000, parts: ['Top', 'Legs'] },
      sofa: { name: 'Sofa', basePrice: 8000, parts: ['Frame', 'Cushions', 'Arms'] },
      cabinet: { name: 'Cabinet', basePrice: 4000, parts: ['Body', 'Doors'] },
      bed: { name: 'Bed Frame', basePrice: 6000, parts: ['Frame', 'Headboard'] },
      bookshelf: { name: 'Bookshelf', basePrice: 3500, parts: ['Frame', 'Shelves'] },
      desk: { name: 'Office Desk', basePrice: 4500, parts: ['Top', 'Legs', 'Drawers'] },
      stool: { name: 'Bar Stool', basePrice: 1500, parts: ['Seat', 'Legs'] }
    };

    // --- STATE ---
    let appState = { items: [], activeItemId: 0, activeLayer: null };
    let isRotating = true; // NEW: Rotation State

    // --- INIT ---
    window.onload = function() {
      const newType = sessionStorage.getItem('targetFurniture');
      const savedState = sessionStorage.getItem('cadState');
      
      if (savedState) appState = JSON.parse(savedState);

      if (newType) {
        const newItem = {
          id: Date.now(),
          type: assetsDB[newType] ? newType : 'chair',
          name: assetsDB[newType] ? assetsDB[newType].name : 'Item',
          selections: {}, dims: {}, carvings: {}, shapes: {}, radius: {}, globalScale: { x: 1, y: 1, z: 1 }
        };
        
        assetsDB[newItem.type].parts.forEach(p => {
          newItem.selections[p] = '#8B4513'; 
          newItem.carvings[p] = 'none'; 
          newItem.shapes[p] = 'square'; 
          newItem.radius[p] = 0; 
          
          if(p === 'Legs') { newItem.dims[p] = { w: 5, h: 45, d: 5 }; newItem.shapes[p] = 'square'; }
          else if(p === 'Seat') { newItem.dims[p] = { w: 45, h: 5, d: 45 }; newItem.shapes[p] = 'square'; }
          else if(p === 'Back') newItem.dims[p] = { w: 45, h: 50, d: 5 };
          else if(p === 'Top') { newItem.dims[p] = { w: 120, h: 5, d: 80 }; newItem.shapes[p] = 'square'; }
          else if(p === 'Frame') newItem.dims[p] = { w: 180, h: 30, d: 80 }; 
          else if(p === 'Cushions') { newItem.dims[p] = { w: 160, h: 15, d: 70 }; newItem.shapes[p] = 'round'; }
          else if(p === 'Arms') newItem.dims[p] = { w: 10, h: 50, d: 80 };
          else if(p === 'Body') newItem.dims[p] = { w: 80, h: 120, d: 40 }; 
          else if(p === 'Doors') newItem.dims[p] = { w: 38, h: 110, d: 2 };
          else if(p === 'Headboard') newItem.dims[p] = { w: 180, h: 80, d: 10 };
          else if(p === 'Shelves') newItem.dims[p] = { w: 75, h: 3, d: 28 };
          else if(p === 'Drawers') newItem.dims[p] = { w: 35, h: 40, d: 50 };
          else newItem.dims[p] = { w: 50, h: 50, d: 50 };
        });
        
        appState.items.push(newItem);
        appState.activeItemId = newItem.id;
        sessionStorage.removeItem('targetFurniture');
        saveState();
      }

      if (appState.items.length === 0) {
        // Fallback for standalone viewing without craft.html
        if(!confirm("No furniture found. Create default chair?")) return;
        sessionStorage.setItem('targetFurniture', 'chair');
        window.location.reload();
        return;
      }

      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      if(activeItem && !appState.activeLayer) {
        appState.activeLayer = assetsDB[activeItem.type].parts[0];
      }
      
      if(activeItem) {
          if(!activeItem.carvings) { activeItem.carvings = {}; assetsDB[activeItem.type].parts.forEach(p => activeItem.carvings[p] = 'none'); }
          if(!activeItem.shapes) { activeItem.shapes = {}; assetsDB[activeItem.type].parts.forEach(p => activeItem.shapes[p] = 'square'); }
          if(!activeItem.radius) { activeItem.radius = {}; assetsDB[activeItem.type].parts.forEach(p => activeItem.radius[p] = 0); }
      }

      renderUI();
      init3D();
    };

    function saveState() { sessionStorage.setItem('cadState', JSON.stringify(appState)); }

    // --- RENDER UI ---
    function renderUI() {
      renderSceneList();
      renderProperties();
      calculateScore();
    }

    function renderSceneList() {
      const list = document.getElementById('scene-list');
      list.innerHTML = '';
      appState.items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `scene-item ${item.id === appState.activeItemId ? 'active' : ''}`;
        div.onclick = (e) => { 
          if(e.target.closest('.btn-delete')) return;
          appState.activeItemId = item.id; 
          appState.activeLayer = assetsDB[item.type].parts[0]; 
          renderUI(); build3DScene(); 
        };
        div.innerHTML = `<span><i class="fas fa-cube"></i> ${item.name}</span>
          <button class="btn-delete" onclick="deleteItem(${item.id})"><i class="fas fa-trash-alt"></i></button>`;
        list.appendChild(div);
      });
    }

    function renderProperties() {
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      if (!activeItem) return;

      document.getElementById('project-name').value = activeItem.name;
      ['x','y','z'].forEach(axis => {
        const val = Math.round(activeItem.globalScale[axis] * 100);
        document.getElementById(`gs-${axis}`).innerText = val;
        document.getElementById(`inp-scale-${axis}`).value = val;
      });

      const recGrid = document.getElementById('rec-mat-grid');
      const allGrid = document.getElementById('all-mat-grid');
      const recContainer = document.getElementById('rec-mat-container');
      recGrid.innerHTML = ''; allGrid.innerHTML = '';
      
      let hasRecs = false;
      Object.keys(materialDB).forEach(k => {
        const m = materialDB[k];
        const isRec = m.rec.includes(activeItem.type);
        if(isRec) hasRecs = true;

        const card = document.createElement('div');
        card.className = `mat-card-lg ${isRec ? 'recommended' : ''}`;
        card.onclick = () => applyMaterialToActiveLayer(m.hex);
        
        card.innerHTML = `<div class="mat-card-icon">${m.icon}</div><div class="mat-card-name">${m.name}</div>`;
        if(isRec) recGrid.appendChild(card);
        else allGrid.appendChild(card);
      });
      recContainer.style.display = hasRecs ? 'block' : 'none';

      const container = document.getElementById('layers-container');
      container.innerHTML = '';
      const assetDef = assetsDB[activeItem.type];
      
      assetDef.parts.forEach(part => {
        const hex = activeItem.selections[part];
        const dims = activeItem.dims[part] || {w:50,h:50,d:50};
        const currentCarving = activeItem.carvings ? activeItem.carvings[part] : 'none';
        const currentShape = activeItem.shapes ? activeItem.shapes[part] : 'square';
        const currentRadius = activeItem.radius ? activeItem.radius[part] : 0;
        const isActive = (appState.activeLayer === part);

        const layer = document.createElement('div');
        layer.className = `layer-item ${isActive ? 'active-layer open' : ''}`;
        
        layer.onclick = (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            setActiveLayer(part);
        };

        const carvingOptions = [
            {v:'none', t:'None (Smooth)'},
            {v:'floral', t:'Classic Floral'},
            {v:'geometric', t:'Geometric'},
            {v:'linear', t:'Linear Grooves'},
            {v:'lattice', t:'Diamond Lattice'},
            {v:'studded', t:'Studded/Tufted'},
            {v:'weave', t:'Basket Weave'},
            {v:'rustic', t:'Rustic/Aged'}
        ].map(opt => `<option value="${opt.v}" ${currentCarving===opt.v ? 'selected' : ''}>${opt.t}</option>`).join('');

        const shapeOptions = [
            {v:'square', t:'Box / Square'},
            {v:'round', t:'Cylinder / Round'},
            {v:'tapered', t:'Tapered'},
        ].map(opt => `<option value="${opt.v}" ${currentShape===opt.v ? 'selected' : ''}>${opt.t}</option>`).join('');

        const showRadius = (currentShape === 'square') ? 'block' : 'none';

        layer.innerHTML = `
          <div class="layer-header">
            <span><i class="fas fa-layer-group"></i> ${part} ${isActive ? '(Selected)' : ''}</span>
            <div class="color-preview" style="background:${hex}"></div>
          </div>
          <div class="layer-content">
            
            <div class="part-control-row">
                <span class="part-control-label">Shape</span>
                <select onchange="updateLayerShape('${part}', this.value)">
                    ${shapeOptions}
                </select>
            </div>

            <div class="part-control-row" style="display:${showRadius}">
                <div class="range-row">
                    <label style="width:auto; font-size:0.75rem; color:#aaa; margin-right:10px;">Corner Radius</label>
                    <input type="range" min="0" max="50" value="${currentRadius}" oninput="updateLayerRadius('${part}', this.value)">
                    <span class="val-display">${currentRadius}%</span>
                </div>
            </div>

            <div class="part-control-row">
                <span class="part-control-label">Carving / Texture</span>
                <select onchange="updateLayerCarving('${part}', this.value)">
                    ${carvingOptions}
                </select>
            </div>

            <div class="part-control-row">
              <span class="part-control-label">Hex Color</span>
              <div class="hex-wrapper">
                <input type="color" value="${hex}" oninput="updateColor('${part}', this.value)">
                <input type="text" class="hex-text-input" value="${hex}" onchange="updateColor('${part}', this.value)">
              </div>
            </div>
            
            <div class="part-control-row">
              <span class="part-control-label">Dimensions (cm)</span>
              <div class="dim-row">
                <div class="dim-group"><input class="dim-input" type="number" value="${dims.w}" oninput="updateDim('${part}','w',this.value)"><div class="dim-label">W</div></div>
                <div class="dim-group"><input class="dim-input" type="number" value="${dims.h}" oninput="updateDim('${part}','h',this.value)"><div class="dim-label">H</div></div>
                <div class="dim-group"><input class="dim-input" type="number" value="${dims.d}" oninput="updateDim('${part}','d',this.value)"><div class="dim-label">D</div></div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(layer);
      });
      updatePrice();
    }

    // --- LOGIC ---
    function setActiveLayer(partName) {
        appState.activeLayer = partName;
        renderProperties(); 
    }

    // NEW: TOGGLE ROTATION FUNCTION
    function toggleRotation() {
      isRotating = !isRotating;
      if(controls) controls.autoRotate = isRotating;
      
      const btn = document.getElementById('btn-rotate');
      if(isRotating) {
        btn.innerHTML = '<i class="fas fa-pause"></i> Stop Rotate';
      } else {
        btn.innerHTML = '<i class="fas fa-play"></i> Auto Rotate';
      }
    }

    function applyMaterialToActiveLayer(hex) {
        if(!appState.activeLayer) {
            alert("Please select a Layer below first.");
            return;
        }
        updateColor(appState.activeLayer, hex);
        renderProperties();
    }

    function updateColor(part, hex) {
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      activeItem.selections[part] = hex;
      if(currentGroup) {
        currentGroup.traverse(mesh => {
          if(mesh.name === part && mesh.isMesh) mesh.material.color.set(hex);
        });
      }
      saveState();
      calculateScore();
    }

    function updateDim(part, axis, val) {
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      if(!activeItem.dims[part]) activeItem.dims[part] = {w:50, h:50, d:50};
      activeItem.dims[part][axis] = parseInt(val) || 0;
      saveState();
      build3DScene(); 
    }

    function updateLayerCarving(part, style) {
        const activeItem = appState.items.find(i => i.id === appState.activeItemId);
        if(!activeItem.carvings) activeItem.carvings = {};
        activeItem.carvings[part] = style;
        saveState();
        build3DScene(); 
    }

    function updateLayerShape(part, shape) {
        const activeItem = appState.items.find(i => i.id === appState.activeItemId);
        if(!activeItem.shapes) activeItem.shapes = {};
        activeItem.shapes[part] = shape;
        saveState();
        renderProperties(); 
        build3DScene(); 
    }

    function updateLayerRadius(part, val) {
        const activeItem = appState.items.find(i => i.id === appState.activeItemId);
        if(!activeItem.radius) activeItem.radius = {};
        activeItem.radius[part] = parseInt(val);
        saveState();
        document.querySelector('.val-display').innerText = val + "%"; 
        build3DScene(); 
    }

    function updateGlobalScale(axis, val) {
      const scale = val / 100;
      document.getElementById(`gs-${axis}`).innerText = val;
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      activeItem.globalScale[axis] = scale;
      if(currentGroup) {
          currentGroup.scale.set(activeItem.globalScale.x, activeItem.globalScale.y, activeItem.globalScale.z);
      }
    }

    function updateProjectName(val) {
        const activeItem = appState.items.find(i => i.id === appState.activeItemId);
        activeItem.name = val;
    }

    function updatePrice() {
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      let total = assetsDB[activeItem.type].basePrice;
      document.getElementById('total-price').innerText = 'â‚±' + total.toLocaleString();
    }

    function calculateScore() {
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      const parts = Object.values(activeItem.selections);
      let totalDura = 0, totalQual = 0, recCount = 0;
      parts.forEach(hex => {
        const matKey = Object.keys(materialDB).find(k => materialDB[k].hex.toLowerCase() === hex.toLowerCase());
        if(matKey) {
          const mat = materialDB[matKey];
          totalDura += mat.dura; totalQual += mat.qual;
          if(mat.rec.includes(activeItem.type)) recCount++;
        } else { totalDura += 50; totalQual += 50; }
      });
      const avgDura = Math.round(totalDura / parts.length) || 0;
      const avgQual = Math.round(totalQual / parts.length) || 0;

      document.getElementById('bar-dura').style.width = avgDura + '%';
      document.getElementById('score-dura-val').innerText = avgDura + '%';
      document.getElementById('bar-dura').style.background = avgDura > 80 ? '#2ecc71' : (avgDura > 50 ? 'orange' : '#e74c3c');
      document.getElementById('bar-qual').style.width = avgQual + '%';
      document.getElementById('score-qual-val').innerText = avgQual + '%';
      
      const statusEl = document.getElementById('rec-status');
      if(recCount === parts.length) statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Optimal Choice';
      else statusEl.innerHTML = '<i class="fas fa-info-circle"></i> Custom Mix';
    }

    function deleteItem(id) {
      if(confirm('Delete?')) {
        appState.items = appState.items.filter(i => i.id !== id);
        if(appState.items.length === 0) window.location.href = 'craft.html';
        else appState.activeItemId = appState.items[0].id;
        saveState(); renderUI(); build3DScene();
      }
    }
    
    function addFurniture() { saveState(); window.location.href = 'craft.html'; }

    // --- 3D ENGINE ---
    let scene, camera, renderer, currentGroup, controls, dimGroup;
    let animationId; 

    function init3D() {
      const container = document.getElementById('canvas-container');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1e1e1e);
      camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
      camera.position.set(8, 6, 10);
      
      renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.innerHTML = ''; container.appendChild(renderer.domElement);
      
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; 
      controls.autoRotate = isRotating; // MODIFIED: Use Global State
      controls.autoRotateSpeed = 0.5;
      
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5, 10, 7); scene.add(light);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      scene.add(new THREE.GridHelper(20, 20, 0x444444, 0x2a2a2a));
      dimGroup = new THREE.Group(); scene.add(dimGroup);
      
      build3DScene(); 
      animate();
    }

    function build3DScene() {
      if(currentGroup) scene.remove(currentGroup);
      currentGroup = new THREE.Group();
      const activeItem = appState.items.find(i => i.id === appState.activeItemId);
      if(!activeItem) return;
      
      if(!activeItem.carvings) activeItem.carvings = {};
      if(!activeItem.shapes) activeItem.shapes = {};
      if(!activeItem.radius) activeItem.radius = {};

      const SCALE_FACTOR = 50; 

      const getDims = (part) => {
          const d = activeItem.dims[part] || { w:50, h:50, d:50 };
          return { w: d.w / SCALE_FACTOR, h: d.h / SCALE_FACTOR, d: d.d / SCALE_FACTOR };
      };

      // FIXED: Completed the make function logic
      const make = (name, x, y, z) => {
        const hex = activeItem.selections[name] || '#888888';
        const partStyle = activeItem.carvings[name] || 'none';
        const shape = activeItem.shapes[name] || 'square';
        const radiusPercent = activeItem.radius[name] || 0;
        const d = getDims(name);
        
        let geo;
        
        if(shape === 'square' && radiusPercent > 0) {
            // Rounded Rectangle Logic 
            const rectW = d.w;
            const rectD = d.d;
            const extrudeH = d.h;
            
            // Calculate radius (max is half the smallest side)
            const maxR = Math.min(rectW, rectD) / 2;
            const r = (radiusPercent / 100) * maxR;
            
            const shapeObj = new THREE.Shape();
            const hw = rectW/2;
            const hd = rectD/2;
            
            // Draw shape centered
            shapeObj.moveTo(-hw + r, -hd);
            shapeObj.lineTo(hw - r, -hd);
            shapeObj.quadraticCurveTo(hw, -hd, hw, -hd + r);
            shapeObj.lineTo(hw, hd - r);
            shapeObj.quadraticCurveTo(hw, hd, hw - r, hd);
            shapeObj.lineTo(-hw + r, hd);
            shapeObj.quadraticCurveTo(-hw, hd, -hw, hd - r);
            shapeObj.lineTo(-hw, -hd + r);
            shapeObj.quadraticCurveTo(-hw, -hd, -hw + r, -hd);

            const extrudeSettings = { steps: 1, depth: extrudeH, bevelEnabled: false };
            geo = new THREE.ExtrudeGeometry(shapeObj, extrudeSettings);
            // Extrude creates geometry starting at Z=0, so center it
            geo.translate(0, 0, -extrudeH/2);
            geo.rotateX(Math.PI/2); // Flip to match BoxGeometry orientation
        }
        else if(shape === 'round') {
            geo = new THREE.CylinderGeometry(d.w/2, d.w/2, d.h, 32);
        }
        else if(shape === 'tapered') {
            geo = new THREE.CylinderGeometry(d.w/3, d.w/2, d.h, 32);
        }
        else {
            geo = new THREE.BoxGeometry(d.w, d.h, d.d);
        }

        const mat = new THREE.MeshStandardMaterial({ color: hex, roughness: 0.6 });

        // Simple Texture Mapping bump map simulation based on style
        if(partStyle !== 'none') {
             // Creating a procedural canvas texture for bump map
             const cvs = document.createElement('canvas');
             cvs.width = 128; cvs.height = 128;
             const ctx = cvs.getContext('2d');
             ctx.fillStyle = '#808080'; ctx.fillRect(0,0,128,128);
             
             ctx.fillStyle = '#ffffff';
             if(partStyle === 'linear') {
                 for(let i=0; i<128; i+=10) ctx.fillRect(0, i, 128, 2);
             } else if(partStyle === 'geometric') {
                 ctx.beginPath(); ctx.arc(64,64,40,0,Math.PI*2); ctx.stroke();
                 ctx.strokeRect(20,20,88,88);
             } else if(partStyle === 'studded') {
                for(let i=10; i<128; i+=30) for(let j=10; j<128; j+=30) {
                    ctx.beginPath(); ctx.arc(i,j,5,0,Math.PI*2); ctx.fill();
                }
             }
             
             const tex = new THREE.CanvasTexture(cvs);
             mat.bumpMap = tex; mat.bumpScale = 0.05;
        }

        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(x, y, z);
        mesh.name = name;
        mesh.castShadow = true; mesh.receiveShadow = true;
        currentGroup.add(mesh);
      };

      // Construct Geometry based on Type
      if(activeItem.type === 'chair') {
        const hLeg = getDims('Legs').h;
        const hSeat = getDims('Seat').h;
        const wSeat = getDims('Seat').w;
        make('Legs', -1, hLeg/2, -1);
        make('Legs', 1, hLeg/2, -1);
        make('Legs', -1, hLeg/2, 1);
        make('Legs', 1, hLeg/2, 1);
        make('Seat', 0, hLeg + hSeat/2, 0);
        make('Back', 0, hLeg + hSeat + getDims('Back').h/2, -0.9);
      }
      else if(activeItem.type === 'table') {
        const hLeg = getDims('Legs').h;
        make('Legs', -1.5, hLeg/2, -1);
        make('Legs', 1.5, hLeg/2, -1);
        make('Legs', -1.5, hLeg/2, 1);
        make('Legs', 1.5, hLeg/2, 1);
        make('Top', 0, hLeg + getDims('Top').h/2, 0);
      }
      else {
        // Generic Stacked Rendering for other types
        let currentY = 0;
        assetsDB[activeItem.type].parts.forEach(p => {
            const dim = getDims(p);
            make(p, 0, currentY + dim.h/2, 0);
            currentY += dim.h;
        });
      }

      currentGroup.scale.set(activeItem.globalScale.x, activeItem.globalScale.y, activeItem.globalScale.z);
      scene.add(currentGroup);
    }

    function animate() {
      requestAnimationFrame(animate);
      if(controls) controls.update();
      renderer.render(scene, camera);
    }

    function exportGIF() {
        const overlay = document.getElementById('export-overlay');
        overlay.style.display = 'flex';
        
        const gif = new GIF({
            workers: 2,
            quality: 10,
            width: 400,
            height: 300
        });

        // Temporarily adjust camera and rotation
        const originalAutoRotate = controls.autoRotate;
        controls.autoRotate = false;
        
        const frames = 30;
        const delta = (Math.PI * 2) / frames;

        for (let i = 0; i < frames; i++) {
            currentGroup.rotation.y = i * delta;
            renderer.render(scene, camera);
            gif.addFrame(renderer.domElement, {copy: true, delay: 100});
        }

        gif.on('finished', function(blob) {
            overlay.style.display = 'none';
            controls.autoRotate = originalAutoRotate;
            currentGroup.rotation.y = 0;
            window.open(URL.createObjectURL(blob));
        });

        gif.render();
    }
  </script>
</body>
</html>