<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FurniCraft - Shop Details</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
      color: #2c3e50;
      line-height: 1.6;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    header {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #CD853F 100%);
      color: white;
      padding: 1rem 2rem;
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 1.8rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3);
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header button {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      margin-right: 1rem;
    }
    .shop-name {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-family: 'Playfair Display', serif;
    }
    .shop-location {
      font-size: 1rem;
      color: #6c757d;
      margin-bottom: 1rem;
    }
    .years-in-business {
      font-weight: 600;
      color: #8B4513;
      margin-bottom: 1rem;
    }
    .detailed-description {
      font-size: 1rem;
      margin-bottom: 2rem;
      white-space: pre-line;
    }
    .button-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    button.action-btn {
      background: linear-gradient(135deg, #8B4513, #CD853F);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      flex: 1 1 200px;
      text-align: center;
    }
    button.action-btn:hover {
      background: linear-gradient(135deg, #A0522D, #D2691E);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
    }
    .project-status {
      font-weight: 600;
      margin-bottom: 1rem;
      color: #2c3e50;
    }
    .project-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 15px;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      font-size: 1rem;
      color: #495057;
    }
    /* Chat Interface */
    .chat-container {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 2rem;
      border: 1px solid rgba(139, 69, 19, 0.1);
      box-shadow: 0 10px 30px rgba(139, 69, 19, 0.1);
      max-width: 800px;
      margin: 2rem auto 0;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #dee2e6;
    }
    .chat-header h2 {
      font-family: 'Playfair Display', serif;
      color: #8B4513;
      margin: 0;
    }
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .back-btn:hover {
      background: #5a6268;
    }
    .chat-messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #f8f9fa;
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-radius: 10px;
      max-width: 70%;
    }
    .message.user {
      background: #8B4513;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    .message.shop {
      background: #e9ecef;
      color: #2c3e50;
    }
    .message img, .message .file-link {
      max-width: 200px;
      max-height: 200px;
      border-radius: 10px;
      margin-top: 0.5rem;
    }
    .chat-inputs {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #dee2e6;
      border-radius: 25px;
      font-size: 1rem;
    }
    .file-input {
      display: none;
    }
    .file-btn, .call-btn, .send-btn {
      background: #8B4513;
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }
    .file-btn:hover, .call-btn:hover, .send-btn:hover {
      background: #A0522D;
      transform: scale(1.1);
    }
    .send-btn {
      border-radius: 25px;
      padding: 0.75rem 1.5rem;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(139, 69, 19, 0.2);
    }
    textarea, input[type="number"], input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0 1rem 0;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
    }
    button.modal-btn {
      background: linear-gradient(135deg, #8B4513, #CD853F);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem;
      transition: all 0.3s ease;
    }
    button.modal-btn:hover {
      background: linear-gradient(135deg, #A0522D, #D2691E);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center;">
      <button id="backBtn" title="Back to Shops">‚Üê Back</button>
      <div>FurniCraft</div>
    </div>
    <div id="userGreeting">Welcome!</div>
  </header>

  <main>
    <section id="shopDetails">
      <h1 class="shop-name" id="shopName">Loading...</h1>
      <div class="shop-location" id="shopLocation"></div>
      <div class="years-in-business" id="yearsInBusiness"></div>
      <div class="detailed-description" id="detailedDescription"></div>

      <div class="button-group">
        <button class="action-btn" id="messageBtn">Send Message to Shop Owner</button>
        <button class="action-btn" id="projectBtn">Send Project Proposal</button>
      </div>

      <div id="projectStatusContainer" style="display:none;">
        <div class="project-status" id="projectStatus"></div>
        <div class="project-info" id="projectInfo"></div>
      </div>
    </section>

    <!-- Chat Interface -->
    <div id="chatContainer" class="chat-container">
      <div class="chat-header">
        <h2 id="chatShopName">Chat with Shop</h2>
        <button class="back-btn" onclick="closeChat()">Back to Details</button>
      </div>
      <div id="chatMessages" class="chat-messages">
        <!-- Messages will be populated here -->
      </div>
      <div class="chat-inputs">
        <input type="text" id="messageInput" class="chat-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
        <input type="file" id="fileInput" class="file-input" accept="image/*,.pdf,.doc,.docx">
        <button class="file-btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-paperclip"></i></button>
        <button class="call-btn" onclick="startCall()"><i class="fas fa-phone"></i></button>
        <button class="send-btn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </main>

  <!-- Project Proposal Modal -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <h3>Send Project Proposal</h3>
      <form id="projectForm">
        <textarea id="projectDescription" placeholder="Describe your project..." required rows="4"></textarea>
        <input type="file" id="projectFile" accept="image/*,.pdf,.doc,.docx" />
        <input type="number" id="projectDuration" placeholder="Estimated duration (days)" min="1" required />
        <div>
          <button type="submit" class="modal-btn">Send Proposal</button>
          <button type="button" class="modal-btn" id="cancelProjectBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Get shop ID from URL query parameter
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Shop data (same as in shop.html)
    const defaultShops = [
      {
        id: 1,
        name: "WoodCraft Masters",
        location: "Downtown, City Center",
        yearsInBusiness: 22,
        detailedDescription: "WoodCraft Masters has been crafting high-quality wooden furniture since 2002. We specialize in custom-made pieces using sustainably sourced hardwoods. Our team of master craftsmen combines traditional techniques with modern design to create timeless furniture that lasts generations. From dining sets to bedroom suites, we handle every project with precision and care."
      },
      {
        id: 2,
        name: "Modern Furnishings Co.",
        location: "Uptown District",
        yearsInBusiness: 15,
        detailedDescription: "Modern Furnishings Co. was established in 2009 with a vision to bring contemporary furniture design to the forefront. We use eco-friendly materials and innovative manufacturing processes to create stylish, durable pieces. Our showroom features the latest trends in modern furniture, and our design team works closely with clients to bring their unique visions to life."
      },
      {
        id: 3,
        name: "Classic Carpentry",
        location: "Old Town",
        yearsInBusiness: 35,
        detailedDescription: "Founded in 1989, Classic Carpentry has been preserving the art of traditional woodworking while embracing modern innovations. Our experienced artisans create furniture that blends classic elegance with contemporary functionality. We specialize in restoration work and custom reproductions of antique pieces, ensuring that each item meets our exacting standards of quality and craftsmanship."
      },
      {
        id: 4,
        name: "EcoWood Creations",
        location: "Green Valley",
        yearsInBusiness: 12,
        detailedDescription: "EcoWood Creations opened its doors in 2012 with a commitment to environmental sustainability. We transform reclaimed wood and recycled materials into beautiful, functional furniture. Our zero-waste approach ensures that every piece we create contributes to a greener planet. From upcycled pallets to salvaged barn wood, we give new life to materials that would otherwise end up in landfills."
      },
      {
        id: 5,
        name: "Urban Furniture Hub",
        location: "Midtown East",
        yearsInBusiness: 8,
        detailedDescription: "Urban Furniture Hub was launched in 2016 to cater to the unique needs of urban living. Our compact, multifunctional designs maximize space without compromising on style. We specialize in apartment-sized furniture that combines practicality with contemporary aesthetics. Our in-house designers stay ahead of urban living trends to offer solutions for small spaces and busy lifestyles."
      },
      {
        id: 6,
        name: "Heritage Woodworks",
        location: "Brooklyn Heights",
        yearsInBusiness: 28,
        detailedDescription: "Established in 1996, Heritage Woodworks honors traditional woodworking heritage while incorporating modern design elements. Our craftsmen draw inspiration from historical furniture pieces, adapting classic forms for contemporary use. We use time-honored joinery techniques and finish our pieces with natural oils and waxes. Each item tells a story of craftsmanship passed down through generations."
      }
    ];

    // Load user name from session storage
    const userName = sessionStorage.getItem('username');
    if (userName) {
      document.getElementById('userGreeting').textContent = `Welcome, ${userName}!`;
    }

    // Elements
    const backBtn = document.getElementById('backBtn');
    const shopNameEl = document.getElementById('shopName');
    const shopLocationEl = document.getElementById('shopLocation');
    const yearsInBusinessEl = document.getElementById('yearsInBusiness');
    const detailedDescriptionEl = document.getElementById('detailedDescription');
    const messageBtn = document.getElementById('messageBtn');
    const projectBtn = document.getElementById('projectBtn');
    const projectModal = document.getElementById('projectModal');
    const projectForm = document.getElementById('projectForm');
    const cancelProjectBtn = document.getElementById('cancelProjectBtn');
    const projectStatusContainer = document.getElementById('projectStatusContainer');
    const projectStatusEl = document.getElementById('projectStatus');
    const projectInfoEl = document.getElementById('projectInfo');

    let selectedShop = null;

    // Load shop details
    function loadShopDetails(shopId) {
      // Try to get shops from localStorage or fallback to default
      let shops = JSON.parse(localStorage.getItem('shops'));
      if (!shops) {
        shops = defaultShops;
      }
      selectedShop = shops.find(s => s.id === parseInt(shopId));
      if (!selectedShop) {
        alert('Shop not found.');
        window.location.href = 'shop.html';
        return;
      }
      shopNameEl.textContent = selectedShop.name;
      shopLocationEl.textContent = selectedShop.location;
      yearsInBusinessEl.textContent = `Years in Business: ${selectedShop.yearsInBusiness}`;
      detailedDescriptionEl.textContent = selectedShop.detailedDescription;

      // Load project proposal status if any
      loadProjectStatus();
    }

    // Navigate back to shop list
    backBtn.addEventListener('click', () => {
      window.location.href = 'shop.html';
    });

    // Send message button opens chat
    messageBtn.addEventListener('click', () => {
      if (!selectedShop) return;
      openChat();
    });

    // Open project proposal modal
    projectBtn.addEventListener('click', () => {
      projectModal.style.display = 'flex';
      projectForm.reset();
    });

    // Close project modal
    cancelProjectBtn.addEventListener('click', () => {
      projectModal.style.display = 'none';
    });

    // Close modal when clicking outside content
    window.addEventListener('click', (event) => {
      if (event.target === projectModal) {
        projectModal.style.display = 'none';
      }
    });

    // Handle project proposal form submission
    projectForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!selectedShop) return;

      const description = document.getElementById('projectDescription').value.trim();
      const duration = parseInt(document.getElementById('projectDuration').value);
      const fileInput = document.getElementById('projectFile');
      let fileData = null;

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
          fileData = {
            name: file.name,
            type: file.type,
            dataUrl: event.target.result
          };
          saveProjectProposal(description, duration, fileData);
        };
        reader.readAsDataURL(file);
      } else {
        saveProjectProposal(description, duration, null);
      }
    });

    // Save project proposal to localStorage
    function saveProjectProposal(description, duration, fileData) {
      const proposalsKey = `projectProposals_shop_${selectedShop.id}`;
      let proposals = JSON.parse(localStorage.getItem(proposalsKey)) || [];

      // Add new proposal with status pending
      const newProposal = {
        id: Date.now(),
        description,
        duration,
        fileData,
        status: 'pending',
        submittedAt: new Date().toISOString(),
        approvedAt: null,
        declinedAt: null
      };
      proposals.push(newProposal);
      localStorage.setItem(proposalsKey, JSON.stringify(proposals));
      projectModal.style.display = 'none';
      alert('Project proposal sent. Waiting for shop approval.');
      loadProjectStatus();
    }

    // Load project status and display
    function loadProjectStatus() {
      if (!selectedShop) return;
      const proposalsKey = `projectProposals_shop_${selectedShop.id}`;
      let proposals = JSON.parse(localStorage.getItem(proposalsKey)) || [];
      if (proposals.length === 0) {
        projectStatusContainer.style.display = 'none';
        return;
      }
      // Show the latest proposal status
      const latestProposal = proposals[proposals.length - 1];
      projectStatusContainer.style.display = 'block';

      if (latestProposal.status === 'pending') {
        projectStatusEl.textContent = 'Project Proposal Status: Pending Approval';
        projectInfoEl.textContent = `Description: ${latestProposal.description}\nEstimated Duration: ${latestProposal.duration} day(s)`;
      } else if (latestProposal.status === 'approved') {
        projectStatusEl.textContent = 'Project Proposal Status: Approved';
        const approvedDate = new Date(latestProposal.approvedAt);
        const completionDate = new Date(approvedDate);
        completionDate.setDate(approvedDate.getDate() + latestProposal.duration);
        projectInfoEl.textContent = `Description: ${latestProposal.description}\nEstimated Duration: ${latestProposal.duration} day(s)\nApproved On: ${approvedDate.toLocaleDateString()}\nExpected Completion: ${completionDate.toLocaleDateString()}`;
      } else if (latestProposal.status === 'declined') {
        projectStatusEl.textContent = 'Project Proposal Status: Declined';
        projectInfoEl.textContent = `Description: ${latestProposal.description}\nDeclined On: ${new Date(latestProposal.declinedAt).toLocaleDateString()}`;
      }
    }

    // For demonstration, simulate shop owner approving or declining proposals after some time
    // This would be replaced by real shop owner actions in a real app
    function simulateShopResponse() {
      if (!selectedShop) return;
      const proposalsKey = `projectProposals_shop_${selectedShop.id}`;
      let proposals = JSON.parse(localStorage.getItem(proposalsKey)) || [];
      if (proposals.length === 0) return;
      const latestProposal = proposals[proposals.length - 1];
      if (latestProposal.status !== 'pending') return;

      // Simulate approval or decline after 10 seconds
      setTimeout(() => {
        const approved = Math.random() > 0.3; // 70% chance approve
        if (approved) {
          latestProposal.status = 'approved';
          latestProposal.approvedAt = new Date().toISOString();
        } else {
          latestProposal.status = 'declined';
          latestProposal.declinedAt = new Date().toISOString();
        }
        proposals[proposals.length - 1] = latestProposal;
        localStorage.setItem(proposalsKey, JSON.stringify(proposals));
        loadProjectStatus();
        alert(`Your project proposal has been ${latestProposal.status}.`);
      }, 10000);
    }

    // Chat functions
    function openChat() {
      if (!selectedShop) return;
      document.getElementById('chatShopName').textContent = `Chat with ${selectedShop.name}`;
      document.getElementById('chatContainer').style.display = 'block';
      document.getElementById('shopDetails').style.display = 'none';
      loadMessages();
      document.getElementById('messageInput').focus();
    }

    function closeChat() {
      document.getElementById('chatContainer').style.display = 'none';
      document.getElementById('shopDetails').style.display = 'block';
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;

      const messagesKey = `chatMessages_shop_${selectedShop.id}`;
      let messages = JSON.parse(localStorage.getItem(messagesKey)) || [];

      messages.push({
        id: Date.now(),
        sender: 'user',
        text: message,
        timestamp: new Date().toISOString(),
        file: null
      });

      localStorage.setItem(messagesKey, JSON.stringify(messages));
      input.value = '';
      loadMessages();

      // Simulate shop response after 2-5 seconds
      setTimeout(() => {
        simulateShopMessage();
      }, 2000 + Math.random() * 3000);
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function startCall() {
      alert('Call feature not implemented yet. This would initiate a video/audio call with the shop owner.');
    }

    function loadMessages() {
      if (!selectedShop) return;
      const messagesKey = `chatMessages_shop_${selectedShop.id}`;
      const messages = JSON.parse(localStorage.getItem(messagesKey)) || [];
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = '';

      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.sender}`;

        if (msg.file) {
          if (msg.file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = msg.file.dataUrl;
            img.alt = msg.file.name;
            messageDiv.appendChild(img);
          } else {
            const link = document.createElement('a');
            link.href = msg.file.dataUrl;
            link.download = msg.file.name;
            link.className = 'file-link';
            link.textContent = `üìé ${msg.file.name}`;
            messageDiv.appendChild(link);
          }
        }

        if (msg.text) {
          const textDiv = document.createElement('div');
          textDiv.textContent = msg.text;
          messageDiv.appendChild(textDiv);
        }

        messagesContainer.appendChild(messageDiv);
      });

      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function simulateShopMessage() {
      if (!selectedShop) return;
      const messagesKey = `chatMessages_shop_${selectedShop.id}`;
      let messages = JSON.parse(localStorage.getItem(messagesKey)) || [];

      const responses = [
        "Thank you for your message! How can I help you today?",
        "I'd be happy to discuss your project requirements.",
        "We specialize in custom furniture. What are you looking for?",
        "Let me check our availability for your timeline.",
        "We can definitely work with your budget. Let's discuss details.",
        "Our team has extensive experience in similar projects.",
        "Would you like to schedule a consultation?",
        "I can provide a detailed quote once we finalize the specifications."
      ];

      const randomResponse = responses[Math.floor(Math.random() * responses.length)];

      messages.push({
        id: Date.now(),
        sender: 'shop',
        text: randomResponse,
        timestamp: new Date().toISOString(),
        file: null
      });

      localStorage.setItem(messagesKey, JSON.stringify(messages));
      loadMessages();
    }

    // Handle file input change
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const messagesKey = `chatMessages_shop_${selectedShop.id}`;
        let messages = JSON.parse(localStorage.getItem(messagesKey)) || [];

        messages.push({
          id: Date.now(),
          sender: 'user',
          text: null,
          timestamp: new Date().toISOString(),
          file: {
            name: file.name,
            type: file.type,
            dataUrl: event.target.result
          }
        });

        localStorage.setItem(messagesKey, JSON.stringify(messages));
        loadMessages();
        e.target.value = ''; // Reset file input
      };
      reader.readAsDataURL(file);
    });

    // Initialize page
    function init() {
      const shopId = getQueryParam('shop');
      if (!shopId) {
        alert('No shop selected.');
        window.location.href = 'shop.html';
        return;
      }
      loadShopDetails(shopId);
      simulateShopResponse();
    }

    init();
  </script>
</body>
</html>
